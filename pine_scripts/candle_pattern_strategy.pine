//@version=6
strategy("Candle Pattern Strategy", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ============================================
// å‚æ•°é…ç½®
// ============================================
lookback_period = input.int(5, title="Kçº¿ç»Ÿè®¡æ•°é‡", minval=3, maxval=20)
crossover_threshold = input.float(0.1, title="åå­—æ˜Ÿé˜ˆå€¼ (0-1)", minval=0.0, maxval=1.0, step=0.05)
cross_count_limit = input.int(3, title="åå­—æ˜Ÿæ•°é‡é™åˆ¶", minval=1, maxval=10)
close_at_high_threshold = input.float(0.9, title="æ”¶æœ€é«˜æ¥è¿‘åº¦ (0-1)", minval=0.5, maxval=1.0, step=0.05)
close_at_low_threshold = input.float(0.9, title="æ”¶æœ€ä½æ¥è¿‘åº¦ (0-1)", minval=0.5, maxval=1.0, step=0.05)
tp_sl_ratio = input.float(2.0, title="æ­¢ç›ˆ/æ­¢æŸæ¯”ä¾‹", minval=1.0, maxval=5.0, step=0.5)
bars_after_open = input.int(5, title="å¼€ç›˜åç¦æ­¢äº¤æ˜“Kçº¿æ•°", minval=0, maxval=50)
cooldown_bars = input.int(2, title="äº¤æ˜“åå†·å´Kçº¿æ•°", minval=0, maxval=20)

// å£°æ˜å†å²ç¼“å†²åŒºå¤§å°ï¼Œç¡®ä¿è¶³å¤Ÿçš„å†å²æ•°æ®
// æ ¹æ®Pine Scriptæ‰§è¡Œæ¨¡å‹ï¼Œéœ€è¦æå‰å£°æ˜æ¥é¿å…è¿è¡Œæ—¶é”™è¯¯
max_bars_back(close, 20)
max_bars_back(open, 20)
max_bars_back(high, 20)
max_bars_back(low, 20)

// ============================================
// ä¸»è¦é€»è¾‘ï¼šåˆ†ææœ€è¿‘Næ ¹Kçº¿
// æ³¨æ„ï¼šç›´æ¥åœ¨å…¨å±€èŒƒå›´è®¿é—®å†å²æ•°æ® [i]ï¼Œé¿å…å‡½æ•°èŒƒå›´å†…çš„å†å²å¼•ç”¨é—®é¢˜
// æŒ‰ç…§Pine Scriptå®˜æ–¹æ‰§è¡Œæ¨¡å‹æ–‡æ¡£çš„è¦æ±‚
// ============================================

// è®°å½•æœ€åä¸€æ¬¡äº¤æ˜“çš„Kçº¿ä½ç½®
var int last_trade_bar = -999

// è®°å½•ä¼šè¯å¼€å§‹çš„Kçº¿ä½ç½®
var int session_start_bar = -999
if session.isfirstbar
    session_start_bar := bar_index

// è®¡ç®—å½“å‰Kçº¿è·ç¦»ä¸Šæ¬¡äº¤æ˜“çš„baræ•°
bars_since_trade = bar_index - last_trade_bar

// è®¡ç®—å½“å‰Kçº¿è·ç¦»ä¼šè¯å¼€å§‹çš„baræ•°
bars_since_session_start = bar_index - session_start_bar

// æ£€æŸ¥æ˜¯å¦åœ¨ç¦æ­¢äº¤æ˜“æœŸï¼šå¼€ç›˜åNæ ¹Kçº¿æˆ–äº¤æ˜“åå†·å´æœŸ
is_within_cooldown = bars_since_trade <= cooldown_bars
is_after_session_start = bars_since_session_start < bars_after_open
trading_allowed = (not is_within_cooldown) and (not is_after_session_start)

// ç»Ÿè®¡è¿‡å»Næ ¹Kçº¿çš„å½¢æ€
close_at_high_count = 0
close_at_low_count = 0
doji_count = 0

// å¾ªç¯ç»Ÿè®¡æœ€è¿‘Næ ¹Kçº¿çš„å½¢æ€
for i = 0 to lookback_period - 1
    // åˆ¤æ–­ç¬¬iæ ¹Kçº¿æ˜¯å¦æ¥è¿‘æ”¶åœ¨æœ€é«˜
    high_range = high[i] - low[i]
    close_to_high_ratio = high_range > 0 ? (high[i] - close[i]) / high_range : 0
    if close_to_high_ratio <= (1 - close_at_high_threshold)
        close_at_high_count += 1
    
    // åˆ¤æ–­ç¬¬iæ ¹Kçº¿æ˜¯å¦æ¥è¿‘æ”¶åœ¨æœ€ä½
    close_to_low_ratio = high_range > 0 ? (close[i] - low[i]) / high_range : 0
    if close_to_low_ratio <= (1 - close_at_low_threshold)
        close_at_low_count += 1
    
    // åˆ¤æ–­ç¬¬iæ ¹Kçº¿æ˜¯å¦æ˜¯åå­—æ˜Ÿ
    body_size = math.abs(close[i] - open[i])
    total_range = high[i] - low[i]
    
    if total_range > 0
        body_ratio = body_size / total_range
        if body_ratio <= crossover_threshold
            doji_count += 1

// æ£€æŸ¥æœ€åä¸€æ ¹Kçº¿ï¼ˆå½“å‰Kçº¿ï¼‰çš„å½¢æ€
high_range_last = high - low
close_to_high_ratio_last = high_range_last > 0 ? (high - close) / high_range_last : 0
last_close_at_high = close_to_high_ratio_last <= (1 - close_at_high_threshold)

close_to_low_ratio_last = high_range_last > 0 ? (close - low) / high_range_last : 0
last_close_at_low = close_to_low_ratio_last <= (1 - close_at_low_threshold)

// ============================================
// ç”Ÿæˆäº¤æ˜“ä¿¡å·
// ============================================

// ä¿¡å·1: å¦‚æœæœ‰3ä¸ªæˆ–ä»¥ä¸Šåå­—æ˜Ÿï¼Œä¸æ“ä½œ
skip_signal = doji_count >= cross_count_limit

// ä¿¡å·2: å¦‚æœ5æ ¹Kçº¿ä¸­æœ‰2ä¸ªæ”¶åœ¨æœ€é«˜ï¼Œä¸”æœ€åä¸€æ ¹æ”¶åœ¨æœ€é«˜ï¼Œåšå¤š
long_signal = (not skip_signal) and (close_at_high_count >= 2) and last_close_at_high and trading_allowed

// ä¿¡å·3: å¦‚æœ5æ ¹Kçº¿ä¸­æœ‰2ä¸ªæ”¶åœ¨æœ€ä½ï¼Œä¸”æœ€åä¸€æ ¹æ”¶åœ¨æœ€ä½ï¼Œåšç©º
short_signal = (not skip_signal) and (close_at_low_count >= 2) and last_close_at_low and trading_allowed

// ============================================
// æ‰§è¡Œäº¤æ˜“
// ============================================

if long_signal
    strategy.entry("Long", strategy.long)
    last_trade_bar := bar_index
    
if short_signal
    strategy.entry("Short", strategy.short)
    last_trade_bar := bar_index

// åŸºäºæœ€åä¸€æ ¹Kçº¿çš„é«˜ä½ç‚¹è®¾ç½®æ­¢æŸæ­¢ç›ˆ
// åšå¤šï¼šæ­¢æŸåœ¨æœ€åä¸€æ ¹Kçº¿çš„æœ€ä½ç‚¹ï¼Œæ­¢ç›ˆä¸ºé£é™©çš„å€æ•°
// åšç©ºï¼šæ­¢æŸåœ¨æœ€åä¸€æ ¹Kçº¿çš„æœ€é«˜ç‚¹ï¼Œæ­¢ç›ˆä¸ºé£é™©çš„å€æ•°
last_bar_low = low
last_bar_high = high

// åšå¤šçš„æ­¢æŸæ­¢ç›ˆ
if long_signal
    sl_long = last_bar_low
    risk_long = close - sl_long
    tp_long = close + (risk_long * tp_sl_ratio)
    strategy.exit("Exit Long", from_entry="Long", stop=sl_long, limit=tp_long)

// åšç©ºçš„æ­¢æŸæ­¢ç›ˆ
if short_signal
    sl_short = last_bar_high
    risk_short = sl_short - close
    tp_short = close - (risk_short * tp_sl_ratio)
    strategy.exit("Exit Short", from_entry="Short", stop=sl_short, limit=tp_short)

// ============================================
// å¯è§†åŒ–
// ============================================


// æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
var table display_table = na
if na(display_table)
    display_table := table.new(position.top_right, 3, 4, bgcolor=color.new(color.white, 80), border_color=color.gray)
    
table.cell(display_table, 0, 0, "å½¢æ€ç»Ÿè®¡", text_color=color.black, bgcolor=color.new(color.gray, 50))
table.cell(display_table, 0, 1, "æ”¶æœ€é«˜: " + str.tostring(close_at_high_count), text_color=color.black)
table.cell(display_table, 0, 2, "æ”¶æœ€ä½: " + str.tostring(close_at_low_count), text_color=color.black)
table.cell(display_table, 0, 3, "åå­—æ˜Ÿ: " + str.tostring(doji_count), text_color=color.black)

// ä¿¡æ¯æ ‡ç­¾
if long_signal
    label.new(bar_index, low, "âœ“ åšå¤šæ¡ä»¶æ»¡è¶³", yloc=yloc.belowbar, color=color.green, textcolor=color.white, style=label.style_label_up)
if short_signal
    label.new(bar_index, high, "âœ“ åšç©ºæ¡ä»¶æ»¡è¶³", yloc=yloc.abovebar, color=color.red, textcolor=color.white, style=label.style_label_down)
if is_within_cooldown
    label.new(bar_index, high, "â¸ å†·å´ä¸­", yloc=yloc.abovebar, color=color.orange, textcolor=color.white, size=size.small)
if is_after_session_start
    label.new(bar_index, high, "ğŸ”’ å¼€ç›˜ç¦æ­¢", yloc=yloc.abovebar, color=color.gray, textcolor=color.white, size=size.small)
